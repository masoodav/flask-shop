name: Trigger Pre-merge build

on:
  workflow_dispatch:  # Allows the workflow to be manually triggered from the GitHub UI

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest

    steps:
    - name: Trigger Jenkins Job
      env:
        JENKINS_URL: ${{ secrets.JENKINS_URL }}
        JENKINS_USER: ${{ secrets.JENKINS_USER }}
        JENKINS_TOKEN: ${{ secrets.JENKINS_TOKEN }}
      run: |
        # Get Jenkins crumb for CSRF protection
        CRUMB=$(curl -u "$JENKINS_USER:$JENKINS_TOKEN" -s "$JENKINS_URL/crumbIssuer/api/json" | jq -r '.crumb')
        
        # Trigger the Jenkins job
        curl -X POST "$JENKINS_URL" \
          --user "$JENKINS_USER:$JENKINS_TOKEN" \
          --header "Jenkins-Crumb:$(curl -u $JENKINS_USER:$JENKINS_TOKEN -s "$JENKINS_URL/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)")"
